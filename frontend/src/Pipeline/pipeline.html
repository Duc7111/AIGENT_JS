<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Aileron</title>
    <link rel="stylesheet" href="../css/pipeline.css" />
    <script src="pipeline.js"></script>
  </head>
  <body>
    <div id="main">
      <div id="header">
        <div id="header-left">
          <img id="ic-back" class="ic" src="../image/ic_back.svg" />
          <button id="btn-project" class="btn">Project Name</button>
          <img id="ic-edit" class="ic" src="../image/ic_edit.svg" />
        </div>
        <div id="header-right">
          <img id="ic-save" class="ic" src="../image/ic_save.svg" />
          <img id="ic-setting" class="ic" src="../image/setting_icon.svg" />
        </div>
      </div>

      <div class="content">
        <div class="content-bar">
          <div class="bar-left">
            <img id="ic-plus" class="ic" src="../image/ic_plus.svg" />
            <button id="btn-import" class="btn">
              <img id="ic-import" src="../image/ic_import.svg" />
              <span class="btn-content">Import</span>
            </button>
          </div>

          <div class="bar-right">
            <button id="btn-run">Run</button>
            <button id="btn-export" class="btn">
              <img src="../image/ic_export.svg" />
              <span class="btn-content">Export</span>
            </button>
          </div>
        </div>

        <div class="main-content">
          <div class="side-menu">
            <div class="search-box">
              <img src="../image/ic_search.svg" />
              <input type="text" placeholder="Search" id="searchInput" />
            </div>

            <!-- Search result -->
            <div class="search-result">
              <div class="menu-header" style="color: rgba(0, 255, 255, 0.707)">
                <div>Search Result</div>
              </div>
              <div class="menu-item"></div>
            </div>

            <!-- IO module -->
            <div class="menu-section">
              <div class="menu-header">
                <span>Input/Output</span>
                <img src="../image/ic_arrow_down.svg" class="ic-expand" />
              </div>
              <div class="menu-item">
                <div class="item">
                  <span
                    class="item-name"
                    f-name="FileReader"
                    module-name="FileReader"
                    file-module="IO"
                    input-name="FileReader_Input"
                    output-name="FileReader_Output"
                    >File Reader</span
                  >
                </div>
                <div class="item">
                  <span
                    class="item-name"
                    f-name="FileWriter"
                    module-name="FileWriter"
                    file-module="IO"
                    input-name="FileWriter_Input"
                    output-name="FileWriter_Output"
                    >File Writer</span
                  >
                </div>
                <div class="item">
                  <span
                    class="item-name"
                    f-name="TextHolder"
                    module-name="TextHolder"
                    file-module="IO"
                    input-name="TextHolder_Input"
                    output-name="TextHolder_Output"
                    >Text Holder</span
                  >
                </div>
                <div class="item">
                  <span
                    class="item-name"
                    f-name="TextGetter"
                    module-name="TextGetter"
                    file-module="IO"
                    input-name="TextGetter_Input"
                    output-name="TextGetter_Output"
                    >Text Getter</span
                  >
                </div>
              </div>
            </div>

            <!-- Hugging Face -->
            <div class="menu-section">
              <div class="menu-header">
                <span>Hugging Face</span>
                <img src="../image/ic_arrow_down.svg" class="ic-expand" />
              </div>
              <div class="menu-item">
                <div class="item">
                  <span
                    class="item-name"
                    f-name="Model"
                    module-name="Model"
                    file-module="HuggingFace"
                    input-name="Model_Input"
                    output-name="Model_Output"
                    >Model</span
                  >
                </div>
                <div class="item">
                  <span
                    class="item-name"
                    f-name="Tokenizer"
                    module-name="Tokenizer"
                    file-module="HuggingFace"
                    input-name="Tokenizer_Input"
                    output-name="Tokenizer_Output"
                    >Tokenizer</span
                  >
                </div>
                <div class="item">
                  <span
                    class="item-name"
                    f-name="Pipeline"
                    module-name="Pipeline"
                    file-module="HuggingFace"
                    input-name="Pipeline_Input"
                    output-name="Pipeline_Output"
                    >Pipeline</span
                  >
                </div>
              </div>
            </div>

            <!-- NN -->
            <div class="menu-section">
              <div class="menu-header">
                <span>Neural Network</span>
                <img src="../image/ic_arrow_down.svg" class="ic-expand" />
              </div>
              <div class="menu-item">
                <div class="item">
                  <span
                    class="item-name"
                    f-name="Perceptron"
                    module-name="Perceptron"
                    file-module="NN"
                    input-name="Perceptron_Input"
                    output-name="Perceptron_Output"
                    >Perceptron</span
                  >
                </div>
                <div class="item">
                  <span
                    class="item-name"
                    f-name="NeuralUnit"
                    module-name="NeuralUnit"
                    file-module="NN"
                    input-name="NeuralUnit_Input"
                    output-name="NeuralUnit_Output"
                    >NeuralUnit</span
                  >
                </div>
              </div>
            </div>
          </div>

          <div id="workspace">
            <canvas id="gridCanvas"></canvas>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.getElementById("ic-back").addEventListener("click", () => {
        window.electron.navigateBack();
      });

      const icSave = document.getElementById("ic-save");
      icSave.addEventListener("click", function () {
        window.electron.savePipeline();
      });

      const btn_run = document.getElementById("btn-run");
      btn_run.addEventListener("click", function () {
        window.electron.runPipeline();
      });

      let draggableItems = [];
      document.addEventListener("DOMContentLoaded", function () {
        // show default first section in the new access
        const menuSections = document.querySelectorAll(".menu-section");
        for (let i = 1; i < menuSections.length; i++) {
          const menuSection = menuSections[i];
          const menuItem = menuSection.querySelector(".menu-item");
          menuItem.style.display = "none";

          const iconExpand = menuSection.querySelector(".ic-expand");
          iconExpand.setAttribute("src", "../image/ic_arrow_up.svg");
        }

        // Expand the menu section when toggle display of menu item
        const menuHeaders = document.querySelectorAll(".menu-header");
        var menuItems = document.querySelectorAll(".menu-item .item");
        console.log("Menu Items Outer:", menuItems);

        menuHeaders.forEach((header) => {
          const menuItem = header.nextElementSibling;
          const iconExpand = header.querySelector(".ic-expand");

          header.addEventListener("click", () => {
            menuItem.style.display =
              menuItem.style.display === "none" ? "flex" : "none";
            const iconSrc = iconExpand.getAttribute("src");
            iconExpand.setAttribute(
              "src",
              iconSrc.includes("ic_arrow_down.svg")
                ? "../image/ic_arrow_up.svg"
                : "../image/ic_arrow_down.svg"
            );
          });
        });

        // Not shown the search result initially
        const searchResult = document.querySelector(".search-result");
        const searchItem = searchResult.querySelector(".menu-item");
        searchResult.style.display = "none";

        // Search items
        const searchInput = document.getElementById("searchInput");
        const items = document.querySelectorAll(".menu-item .item");

        let hasResults = false;
        let search_click = false;
        searchInput.addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            const searchTerm = searchInput.value.trim().toLowerCase();

            searchItem.innerHTML = "";
            hasResults = false;

            if (searchTerm !== "") {
              items.forEach((item) => {
                const itemName = item
                  .querySelector(".item-name")
                  .textContent.toLowerCase();

                if (itemName.includes(searchTerm)) {
                  const cloneItem = item.cloneNode(true);
                  searchItem.appendChild(cloneItem);
                  hasResults = true;
                }
              });
            }

            if (hasResults) {
              searchResult.style.display = "block";
              search_click = true;
              menuItems = document.querySelectorAll(".menu-item .item");
              menuItems.forEach((item) => {
                item.draggable = true;
                item.addEventListener("dragstart", function (e) {
                  const originalItemName =
                    e.target.querySelector(".item-name").textContent;
                  if (search_click == true) {
                    const itemName = generateUniqueItemName(originalItemName);
                    e.dataTransfer.setData("text/plain", itemName);
                  }
                });
              });
            } else {
              searchResult.style.display = "none";
              search_click = false;
            }
          }
        });

        // Create and move the canvas
        const workspace = document.getElementById("workspace");
        const canvas = document.getElementById("gridCanvas");
        const ctx = canvas.getContext("2d");
        const gridSize = 40;
        const width = workspace.clientWidth;
        const height = workspace.clientHeight;
        canvas.width = width;
        canvas.height = height;

        function drawGrid() {
          ctx.strokeStyle = "#e0e0e0";
          ctx.beginPath();

          for (let x = 0; x <= width; x += gridSize) {
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
          }

          for (let y = 0; y <= height; y += gridSize) {
            ctx.moveTo(0, y);
            ctx.lineTo(width, y);
          }

          ctx.stroke();
        }

        drawGrid();

        let isDragging = false;
        let lastPosX = 0;
        let lastPosY = 0;
        let scale = 1;
        const zoomSensitivity = 0.1;

        function getMinimumScale() {
          const workspaceWidth = workspace.clientWidth;
          const workspaceHeight = workspace.clientHeight;
          const canvasWidth = canvas.width;
          const canvasHeight = canvas.height;

          const scaleX = workspaceWidth / canvasWidth;
          const scaleY = workspaceHeight / canvasHeight;

          return Math.max(scaleX, scaleY);
        }

        workspace.addEventListener("wheel", function (e) {
          e.preventDefault();

          const delta = e.deltaY * -0.01;
          const oldScale = scale;
          const newPotentialScale = scale + delta * zoomSensitivity;

          const minScale = getMinimumScale();
          scale = Math.max(minScale, newPotentialScale);
          scale = Math.min(scale, 4);

          const rect = canvas.getBoundingClientRect();
          const x = (e.clientX - rect.left) / scale;
          const y = (e.clientY - rect.top) / scale;

          const newWidth = canvas.width * scale;
          const newHeight = canvas.height * scale;
          const dx = x * (newWidth / canvas.width - oldScale);
          const dy = y * (newHeight / canvas.height - oldScale);

          workspace.scrollLeft += dx;
          workspace.scrollTop += dy;

          canvas.style.width = `${newWidth}px`;
          canvas.style.height = `${newHeight}px`;
          drawItems();
        });

        // Drag and drop functionality
        let unique_item_name = [];
        let draggedItem = null;
        let selectedItemIndex = null;
        let dragOffsetX = 0;
        let dragOffsetY = 0;

        menuItems = document.querySelectorAll(".menu-item .item");
        menuItems.forEach((item) => {
          item.draggable = true;
          item.addEventListener("dragstart", function (e) {
            const originalItemName =
              e.target.querySelector(".item-name").textContent;
            if (search_click == false) {
              const itemName = generateUniqueItemName(originalItemName);
              e.dataTransfer.setData("text/plain", itemName);
            }
          });
        });

        function generateUniqueItemName(itemName) {
          if (!(itemName in unique_item_name)) {
            // First occurrence of this itemName, store count as 1
            unique_item_name[itemName] = 1;
            return itemName;
          } else {
            // Increment the count for this itemName
            unique_item_name[itemName]++;
            const count = unique_item_name[itemName];
            return `${itemName}_${count}`;
          }
        }

        workspace.addEventListener("dragover", function (e) {
          e.preventDefault();
        });

        workspace.addEventListener("drop", function (e) {
          e.preventDefault();
          const itemName = e.dataTransfer.getData("text/plain");

          // add module to the pipeline
          const draggedElement = document.querySelector(
            `[f-name="${itemName}"]`
          );
          console.log("Drag & Drop:", itemName);
          if (draggedElement) {
            const moduleName = draggedElement.getAttribute("module-name");
            const fileModule = draggedElement.getAttribute("file-module");

            console.log("Item dragged:", itemName);
            console.log("Module Name:", moduleName);
            console.log("File Module:", fileModule);

            window.electron.addModule(itemName, fileModule, moduleName);
          }

          const x = e.clientX - workspace.getBoundingClientRect().left;
          const y = e.clientY - workspace.getBoundingClientRect().top;

          if (itemName.includes("File Reader")) {
            draggableItems.push({
              originalName: itemName,
              name: "Click to choose file",
              x: x,
              y: y,
              dragging: false,
            });
          } else {
            draggableItems.push({
              originalName: itemName,
              name: itemName,
              x: x,
              y: y,
              dragging: false,
            });
          }
          drawItems();
        });

        workspace.addEventListener("click", function (e) {
          const rect = canvas.getBoundingClientRect();
          const mouseX = (e.clientX - rect.left) / scale;
          const mouseY = (e.clientY - rect.top) / scale;

          draggableItems.forEach((item) => {
            const hitbox = {
              x: item.x * scale,
              y: (item.y - 16) * scale,
              width: ctx.measureText(item.name).width * scale,
              height: 16 * scale,
            };
            if (
              mouseX >= hitbox.x &&
              mouseX <= hitbox.x + hitbox.width &&
              mouseY >= hitbox.y &&
              mouseY <= hitbox.y + hitbox.height
            ) {
              if (item.originalName.includes("File Reader")) {
                const inputFile = document.createElement("input");
                inputFile.type = "file";
                inputFile.click();

                inputFile.addEventListener("change", function (e) {
                  const selectedFile = e.target.files[0];
                  const fileName = selectedFile
                    ? selectedFile.name
                    : "No file chosen";
                  item.name = fileName;
                  drawItems();
                  console.log("Selected file:", selectedFile.path);
                });
              }
            }
          });
        });

        function isMouseOverItem(mouseX, mouseY, item) {
          const hitbox = {
            x: item.x * scale,
            y: (item.y - 16) * scale,
            width: ctx.measureText(item.name).width * scale,
            height: 16 * scale,
          };
          return (
            mouseX >= hitbox.x &&
            mouseX <= hitbox.x + hitbox.width &&
            mouseY >= hitbox.y &&
            mouseY <= hitbox.y + hitbox.height
          );
        }

        let markerX = 0;
        let markerY = 0;
        let isDraggingMarker = false;
        let startItemIndex = null;

        // Function to draw items on the canvas
        canvas.addEventListener("mousedown", function (e) {
          isDragging = true;
          lastPosX = e.clientX;
          lastPosY = e.clientY;

          const rect = canvas.getBoundingClientRect();
          const mouseX = (e.clientX - rect.left) / scale;
          const mouseY = (e.clientY - rect.top) / scale;

          draggableItems.forEach((item, index) => {
            const hitbox = {
              x: item.x * scale,
              y: (item.y - 16) * scale,
              width: ctx.measureText(item.name).width * scale,
              height: 16 * scale,
            };
            if (
              mouseX >= hitbox.x &&
              mouseX <= hitbox.x + hitbox.width &&
              mouseY >= hitbox.y &&
              mouseY <= hitbox.y + hitbox.height
            ) {
              selectedItemIndex = index;
              dragOffsetX = mouseX - hitbox.x;
              dragOffsetY = mouseY - hitbox.y;
              isDragging = false;
            }

            if (
              mouseX >= item.x + ctx.measureText(item.name).width &&
              mouseX <= item.x + ctx.measureText(item.name).width + 12 &&
              mouseY >= item.y - 8 &&
              mouseY <= item.y + 8
            ) {
              console.log("Marker");
              isDraggingMarker = true;
              startItemIndex = index;
              markerX = mouseX;
              markerY = mouseY;
            }
          });
        });

        canvas.addEventListener("mousemove", function (e) {
          const rect = canvas.getBoundingClientRect();
          const mouseX = (e.clientX - rect.left) / scale;
          const mouseY = (e.clientY - rect.top) / scale;
          let isOverItem = false;
          let isOverMarker = false;

          draggableItems.forEach((item, index) => {
            if (isMouseOverItem(mouseX, mouseY, item)) {
              isOverItem = true;
              if (selectedItemIndex === null) {
                canvas.style.cursor = "pointer";
              }
            }

            if (
              mouseX >= item.x + ctx.measureText(item.name).width &&
              mouseX <= item.x + ctx.measureText(item.name).width + 12 &&
              mouseY >= item.y - 8 &&
              mouseY <= item.y + 8
            ) {
              isOverMarker = true;
              draggableItems[index].markerColor = "blue";
              drawItems();
            } else {
              draggableItems[index].markerColor = "red";
              drawItems();
            }
          });

          if (!isOverItem && selectedItemIndex === null) {
            canvas.style.cursor = "default";
          }

          if (selectedItemIndex !== null) {
            draggableItems[selectedItemIndex].x = mouseX - dragOffsetX;
            draggableItems[selectedItemIndex].y = mouseY - dragOffsetY;

            drawItems();
          }

          if (isDragging) {
            const deltaX = e.clientX - lastPosX;
            const deltaY = e.clientY - lastPosY;
            const rect = workspace.getBoundingClientRect();
            workspace.scrollLeft -= deltaX;
            workspace.scrollTop -= deltaY;
            lastPosX = e.clientX;
            lastPosY = e.clientY;
          }

          if (isDraggingMarker) {
            markerX = mouseX;
            markerY = mouseY;
          }
        });

        canvas.addEventListener("mouseup", function () {
          selectedItemIndex = null;
          isDragging = false;

          if (isDraggingMarker) {
            isDraggingMarker = false;
            startItemIndex = null;
          }
        });

        canvas.addEventListener("mouseleave", function () {
          selectedItemIndex = null;
          isDragging = false;
        });

        function drawItems() {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          drawGrid();
          draggableItems.forEach((item) => {
            ctx.save();
            ctx.scale(scale, scale);
            ctx.font = "16px Arial";
            ctx.fillStyle = "white";
            ctx.fillText(item.name, item.x, item.y);

            const markerSize = 6;
            const markerX = item.x + ctx.measureText(item.name).width + 5;
            const markerY = item.y - 8;
            ctx.fillStyle = item.markerColor || "red";
            ctx.beginPath();
            ctx.arc(markerX, markerY, markerSize, 0, 2 * Math.PI);
            ctx.fill();

            ctx.restore();
          });

          draggableItems.forEach((item, index) => {
            if (index !== startItemIndex && isDraggingMarker) {
              ctx.beginPath();
              ctx.moveTo(
                item.x + ctx.measureText(item.name).width + 5,
                item.y - 8
              );
              ctx.lineTo(markerX, markerY);
              ctx.strokeStyle = "red";
              ctx.lineWidth = 1;
              ctx.stroke();
            }
          });
        }
      });
    </script>
  </body>
</html>
