<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Aileron</title>
    <link rel="stylesheet" href="../css/pipeline.css" />
    <script src="pipeline.js"></script>
  </head>
  <body>
    <div id="main">
      <div id="header">
        <div id="header-left">
          <img id="ic-back" class="ic" src="../image/ic_back.svg" />
          <button id="btn-project" class="btn">Project Name</button>
          <img id="ic-edit" class="ic" src="../image/ic_edit.svg" />
        </div>
        <div id="header-right">
          <img id="ic-save" class="ic" src="../image/ic_save.svg" />
          <img id="ic-setting" class="ic" src="../image/setting_icon.svg" />
        </div>
      </div>

      <div class="content">
        <div class="content-bar">
          <div class="bar-left">
            <img id="ic-plus" class="ic" src="../image/ic_plus.svg" />
            <button id="btn-import" class="btn">
              <img id="ic-import" src="../image/ic_import.svg" />
              <span class="btn-content">Import</span>
            </button>
          </div>

          <div class="bar-right">
            <button id="btn-run">Run</button>
            <button id="btn-export" class="btn">
              <img src="../image/ic_export.svg" />
              <span class="btn-content">Export</span>
            </button>
          </div>
        </div>

        <div id="workspace">
          <canvas id="gridCanvas"></canvas>
        </div>
      </div>
    </div>

    <script>
      document.getElementById("ic-back").addEventListener("click", () => {
        window.electron.navigateBack();
      });

      const icSave = document.getElementById("ic-save");
      icSave.addEventListener("click", function () {
        window.electron.savePipeline();
      });

      document.addEventListener("DOMContentLoaded", function () {
        const workspace = document.getElementById("workspace");
        const canvas = document.getElementById("gridCanvas");
        const ctx = canvas.getContext("2d");
        const gridSize = 40;
        const width = workspace.clientWidth;
        const height = workspace.clientHeight;
        canvas.width = width;
        canvas.height = height;

        function drawGrid() {
          ctx.strokeStyle = "#e0e0e0";
          ctx.beginPath();

          for (let x = 0; x <= width; x += gridSize) {
            ctx.moveTo(x, 0);
            ctx.lineTo(x, height);
          }

          for (let y = 0; y <= height; y += gridSize) {
            ctx.moveTo(0, y);
            ctx.lineTo(width, y);
          }

          ctx.stroke();
        }

        drawGrid();

        let isDragging = false;
        let lastPosX = 0;
        let lastPosY = 0;

        canvas.addEventListener("mousedown", function (e) {
          isDragging = true;
          lastPosX = e.clientX;
          lastPosY = e.clientY;
        });

        canvas.addEventListener("mousemove", function (e) {
          if (isDragging) {
            const deltaX = e.clientX - lastPosX;
            const deltaY = e.clientY - lastPosY;
            const rect = workspace.getBoundingClientRect();
            workspace.scrollLeft -= deltaX;
            workspace.scrollTop -= deltaY;
            lastPosX = e.clientX;
            lastPosY = e.clientY;
          }
        });

        canvas.addEventListener("mouseup", function (e) {
          isDragging = false;
        });

        canvas.addEventListener("mouseleave", function (e) {
          isDragging = false;
        });

        let scale = 1;
        const zoomSensitivity = 0.1;

        function getMinimumScale() {
          const workspaceWidth = workspace.clientWidth;
          const workspaceHeight = workspace.clientHeight;
          const canvasWidth = canvas.width;
          const canvasHeight = canvas.height;

          const scaleX = workspaceWidth / canvasWidth;
          const scaleY = workspaceHeight / canvasHeight;

          return Math.max(scaleX, scaleY);
        }

        workspace.addEventListener("wheel", function (e) {
          e.preventDefault();

          const delta = e.deltaY * -0.01;
          const oldScale = scale;
          const newPotentialScale = scale + delta * zoomSensitivity;

          const minScale = getMinimumScale();
          scale = Math.max(minScale, newPotentialScale);
          scale = Math.min(scale, 4);

          const rect = canvas.getBoundingClientRect();
          const x = e.clientX - rect.left;
          const y = e.clientY - rect.top;

          const newWidth = canvas.width * scale;
          const newHeight = canvas.height * scale;
          const dx = x * (newWidth / canvas.width - oldScale);
          const dy = y * (newHeight / canvas.height - oldScale);

          workspace.scrollLeft += dx;
          workspace.scrollTop += dy;

          canvas.style.width = `${newWidth}px`;
          canvas.style.height = `${newHeight}px`;
        });
      });
    </script>
  </body>
</html>
